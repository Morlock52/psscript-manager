import{u as e,j as s,r as t}from"./react-vendor-chunk-d925dc83.js";import{u as r,d as i}from"./data-fetching-chunk-60e2cc94.js";import{s as l,c as a,t as n}from"../assets/index-c53f325e.js";import"./editor-chunk-85777d73.js";const c=({isOpen:t,onClose:r,existingScriptId:i,existingScriptTitle:l,message:a})=>{const n=e();if(!t)return null;return s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[s.jsxs("div",{className:"flex items-start mb-4",children:[s.jsx("div",{className:"flex-shrink-0 bg-yellow-500 rounded-full p-2",children:s.jsx("svg",{className:"h-6 w-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),s.jsxs("div",{className:"ml-3 flex-1",children:[s.jsx("h3",{className:"text-lg font-medium text-white",children:"Duplicate Script Detected"}),s.jsxs("div",{className:"mt-2 text-sm text-gray-300",children:[s.jsx("p",{children:a||"This script content has already been uploaded."}),l&&s.jsxs("p",{className:"mt-2",children:[s.jsx("span",{className:"font-semibold",children:"Existing script:"})," ",l]})]})]})]}),s.jsxs("div",{className:"mt-4 text-sm text-gray-400",children:[s.jsx("p",{children:"You can:"}),s.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-1",children:[s.jsx("li",{children:"View the existing script to see its details"}),s.jsx("li",{children:"Update the existing script with new metadata"}),s.jsx("li",{children:"Cancel and modify your script to make it unique"})]})]}),s.jsxs("div",{className:"mt-6 flex flex-col sm:flex-row gap-3",children:[s.jsx("button",{onClick:()=>{i&&n(`/scripts/${i}`),r()},className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500",children:"View Existing Script"}),s.jsx("button",{onClick:()=>{i&&n(`/scripts/${i}/edit`),r()},className:"flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500",children:"Update Existing"}),s.jsx("button",{onClick:r,className:"flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500",children:"Cancel"})]})]})})},d=()=>{const d=e(),o=t.useRef(null),[x,u]=t.useState(""),[m,p]=t.useState(""),[g,h]=t.useState(""),[b,y]=t.useState(""),[j,f]=t.useState([]),[v,N]=t.useState(!1),[w,S]=t.useState(!0),[k,C]=t.useState(""),[F,P]=t.useState(""),[D,_]=t.useState(0),[z,T]=t.useState(""),[A,M]=t.useState(""),[q,E]=t.useState(!1),[L,I]=t.useState(0),[U,B]=t.useState(!1),[O,$]=t.useState(null),[R,K]=t.useState(!1),[W,V]=t.useState(0),[J,Q]=t.useState(!1),[Y,G]=t.useState({}),{data:H}=r({queryKey:["categories"],queryFn:()=>a.getCategories()}),{data:X}=r({queryKey:["tags"],queryFn:()=>n.getTags()}),Z=i({mutationFn:e=>l.uploadScript(e,q),onSuccess:e=>{console.log("Script uploaded successfully:",e),I(0),K(!1),V(0);const s=e.script?.id||e.id;s?setTimeout(()=>{d(`/scripts/${s}`)},300):d("/scripts")},onError:e=>{if(console.error("Error uploading script:",e),I(0),e.isDuplicate||409===e.status)return G({id:e.existingScriptId,title:e.existingScriptTitle,message:e.message}),Q(!0),void P("");const s=e.message?.includes("Network error")||e.message?.includes("check your connection")||e.message?.includes("No response received")||e.message?.includes("timeout");K(s),P(e.message||"Failed to upload script. Please try again.")},retry:(e,s)=>(s.message?.includes("Network error")||s.message?.includes("check your connection")||s.message?.includes("No response received")||s.message?.includes("timeout"))&&e<3,retryDelay:e=>Math.min(1e3*2**e,1e4),onMutate:()=>{P(""),K(!1)}}),ee=i({mutationFn:e=>l.analyzeScript(e)}),se=[".ps1",".psm1",".psd1",".ps1xml"];t.useEffect(()=>{if(Z.isPending){const e=setInterval(()=>{I(e=>{const s=e+15*Math.random();return s>=95?95:s})},500);return()=>clearInterval(e)}Z.isSuccess&&I(100),Z.failureCount>W&&Z.failureCount<=3&&V(Z.failureCount)},[Z.isPending,Z.isSuccess,Z.failureCount,W,3]);const te=()=>{const e=new FormData;return e.append("title",x),e.append("description",m),e.append("content",g),b&&e.append("category_id",b),j.length>0&&e.append("tags",JSON.stringify(j)),e.append("is_public",v.toString()),e.append("analyze_with_ai",w.toString()),o.current?.files?.[0]&&e.append("script_file",o.current.files[0]),e};return s.jsxs("div",{className:"container mx-auto pb-8",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"Upload Script"}),s.jsx("div",{className:"flex space-x-2",children:s.jsx("button",{className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",onClick:()=>d("/"),children:"Dashboard"})})]}),s.jsx("div",{className:"bg-gray-700 rounded-lg shadow p-6",children:s.jsxs("form",{onSubmit:e=>{e.preventDefault();const s=x&&""!==x.trim()?g&&""!==g.trim()?j.length>10?"A maximum of 10 tags is allowed":null:"Script content is required":"Script title is required";if(s)return void P(s);P(""),I(0),V(0);const t=te();Z.mutate(t)},children:[s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[s.jsxs("div",{className:"border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors",onClick:()=>o.current?.click(),onDrop:e=>{e.preventDefault();const s=e.dataTransfer.files[0];if(s&&o.current){const e=new DataTransfer;e.items.add(s),o.current.files=e.files;const t=new Event("change",{bubbles:!0});o.current.dispatchEvent(t)}},onDragOver:e=>{e.preventDefault()},children:[s.jsx("input",{type:"file",ref:o,className:"hidden",accept:".ps1,.psm1,.psd1,.ps1xml",onChange:e=>{const s=e.target.files?.[0];if(!s)return;const t=("."+s.name.split(".").pop()).toLowerCase();if(!se.includes(t))return void P(`Only PowerShell files (${se.join(", ")}) are allowed`);const r=s.size/1048576;if(_(s.size),T(s.name),M(t),E(r>2),r>10)return void P("File size exceeds the maximum limit of 10MB");P("");const i=new FileReader;i.onload=e=>{const r=e.target?.result;if(h(r),!x){const e=s.name.replace(t,"");u(e)}B(!1),$(null)},i.readAsText(s)}}),s.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48","aria-hidden":"true",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 14v20c0 4.418 7.163 8 16 8 1.381 0 2.721-.087 4-.252M8 14c0 4.418 7.163 8 16 8s16-3.582 16-8M8 14c0-4.418 7.163-8 16-8s16 3.582 16 8m0 0v14m0-4c0 4.418-7.163 8-16 8S8 28.418 8 24m32 10v6m0 0v6m0-6h6m-6 0h-6"})}),s.jsx("p",{className:"mt-2 text-sm text-gray-400",children:"Drag and drop your PowerShell script here, or click to browse"}),s.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Accepted file types: .ps1, .psm1, .psd1, .ps1xml"}),F&&s.jsxs("div",{className:"mt-2",children:[s.jsx("p",{className:"text-sm text-red-500",children:F}),R&&s.jsx("button",{onClick:()=>{P(""),I(0),K(!1),V(0);const e=te();Z.mutate(e)},className:"mt-2 px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500",children:"Retry Upload"}),W>0&&W<=3&&s.jsxs("p",{className:"text-xs text-yellow-500 mt-1",children:["Retry attempt ",W," of ",3]})]}),g&&!F&&s.jsxs("p",{className:"mt-2 text-sm text-green-500",children:["âœ“ Script loaded successfully (",g.length," bytes)"]}),z&&!F&&s.jsxs("div",{className:"mt-2 text-sm text-gray-300",children:[s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"File:"})," ",z]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"Size:"})," ",(re=D,re<1024?re+" bytes":re<1048576?(re/1024).toFixed(1)+" KB":(re/1048576).toFixed(2)+" MB")]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"Type:"})," ",A," ",q&&s.jsx("span",{className:"text-yellow-400",children:"(Large file upload)"})]})]}),Z.isPending&&s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2.5",children:s.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full transition-all duration-300",style:{width:`${L}%`}})}),s.jsxs("p",{className:"text-gray-400 text-sm mt-1 text-center",children:[L<100?"Uploading...":"Processing..."," ",Math.round(L),"%"]})]})]}),g&&s.jsxs("div",{className:"border border-gray-600 rounded-lg overflow-hidden",children:[s.jsxs("div",{className:"bg-gray-800 px-4 py-2 border-b border-gray-600 flex justify-between items-center",children:[s.jsx("h2",{className:"text-sm font-medium",children:"Script Content Preview"}),s.jsxs("span",{className:"text-xs text-gray-400",children:[g.split("\n").length," lines"]})]}),s.jsx("pre",{className:"p-4 bg-gray-900 text-sm font-mono text-gray-300 overflow-x-auto max-h-60",children:g})]}),U&&O&&s.jsxs("div",{className:"border border-gray-600 rounded-lg overflow-hidden",children:[s.jsx("div",{className:"bg-gray-800 px-4 py-2 border-b border-gray-600",children:s.jsx("h2",{className:"text-sm font-medium",children:"AI Analysis Preview"})}),s.jsx("div",{className:"p-4 bg-gray-900",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-xs uppercase text-gray-400 mb-1",children:"Purpose"}),s.jsx("p",{className:"text-sm text-white",children:O.purpose})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-xs uppercase text-gray-400 mb-1",children:"Category"}),s.jsx("p",{className:"text-sm text-white",children:O.category})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-xs uppercase text-gray-400 mb-1",children:"Security Score"}),s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"w-full bg-gray-800 rounded-full h-2 mr-2",children:s.jsx("div",{className:"h-2 rounded-full "+(O.security_score>7?"bg-green-500":O.security_score>4?"bg-yellow-500":"bg-red-500"),style:{width:10*O.security_score+"%"}})}),s.jsxs("span",{className:"text-sm",children:[O.security_score,"/10"]})]})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-xs uppercase text-gray-400 mb-1",children:"Code Quality"}),s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"w-full bg-gray-800 rounded-full h-2 mr-2",children:s.jsx("div",{className:"bg-blue-500 h-2 rounded-full",style:{width:10*O.code_quality_score+"%"}})}),s.jsxs("span",{className:"text-sm",children:[O.code_quality_score,"/10"]})]})]})]})})]})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsxs("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-300 mb-1",children:["Title ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{id:"title",type:"text",value:x,onChange:e=>u(e.target.value),className:"w-full bg-gray-800 border border-gray-600 rounded-md text-white px-3 py-2",placeholder:"Script title",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-300 mb-1",children:"Description"}),s.jsx("textarea",{id:"description",value:m,onChange:e=>p(e.target.value),className:"w-full bg-gray-800 border border-gray-600 rounded-md text-white px-3 py-2",placeholder:"What does this script do?",rows:3})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"category",className:"block text-sm font-medium text-gray-300 mb-1",children:"Category"}),s.jsxs("select",{id:"category",value:b,onChange:e=>y(e.target.value),className:"w-full bg-gray-800 border border-gray-600 rounded-md text-white px-3 py-2",children:[s.jsx("option",{value:"",children:"-- Select Category --"}),H?.categories?.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Tags"}),s.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:X?.tags?.slice(0,10).map(e=>s.jsx("button",{type:"button",onClick:()=>(e=>{j.includes(e)?f(j.filter(s=>s!==e)):f([...j,e])})(e.name),className:"text-xs px-2 py-1 rounded-full "+(j.includes(e.name)?"bg-blue-600 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"),children:e.name},e.id))}),s.jsxs("div",{className:"flex",children:[s.jsx("input",{type:"text",value:k,onChange:e=>C(e.target.value),className:"flex-1 bg-gray-800 border border-gray-600 rounded-l-md text-white px-3 py-2 text-sm",placeholder:"Add custom tag"}),s.jsx("button",{type:"button",onClick:()=>{k.trim()&&!j.includes(k.trim())&&(f([...j,k.trim()]),C(""))},className:"bg-blue-600 text-white px-3 py-2 rounded-r-md hover:bg-blue-700",children:"Add"})]})]}),s.jsxs("div",{className:"flex items-center",children:[s.jsx("input",{id:"is-public",type:"checkbox",checked:v,onChange:e=>N(e.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded"}),s.jsx("label",{htmlFor:"is-public",className:"ml-2 block text-sm text-gray-300",children:"Make script public"})]}),s.jsxs("div",{className:"flex items-center",children:[s.jsx("input",{id:"analyze-ai",type:"checkbox",checked:w,onChange:e=>S(e.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded"}),s.jsx("label",{htmlFor:"analyze-ai",className:"ml-2 block text-sm text-gray-300",children:"Analyze with AI"})]}),g&&w&&!U&&s.jsx("button",{type:"button",onClick:()=>{g&&ee.mutate(g,{onSuccess:e=>{$(e),B(!0)}})},className:"w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md",disabled:ee.isPending,children:ee.isPending?"Analyzing...":"Preview Analysis"})]})]}),s.jsxs("div",{className:"mt-8 flex justify-end space-x-4",children:[s.jsx("button",{type:"button",onClick:()=>d("/scripts"),className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!x||!g||!!F||Z.isPending,children:Z.isPending?"Uploading...":"Upload Script"})]})]})}),s.jsx(c,{isOpen:J,onClose:()=>{Q(!1),G({})},existingScriptId:Y.id,existingScriptTitle:Y.title,message:Y.message})]});var re};export{d as default};
